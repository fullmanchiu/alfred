version: 1.0
name: Alfred CI/CD

description: Alfred 项目持续集成与部署

triggers:
  push:
    include:
      - main
  manual:
    enable: true
    branches:
      - '*'
      - '!main'

variables:
  # SSH连接信息（在Gitee Go后台配置）
  SSH_HOST: $SSH_HOST
  SSH_USER: $SSH_USER
  SSH_KEY: $SSH_KEY
  PROJECT_PATH: $PROJECT_PATH

stages:
  - name: build
    display_name: 构建
    jobs:
      - name: backend-test
        display_name: 后端测试
        runner:
          env: pipeline
        condition:
          var: CI_COMMIT_REF_NAME
          operator: eq
          value: main
        steps:
          - name: 检出代码
            run: |
              git clone --branch=$CI_COMMIT_REF_NAME https://gitee.com/$CI_REPO_SLUG.git .
              git log -1

          - name: 后端测试
            run: |
              cd backend
              ./gradlew test --no-daemon
            timeout: 600

      - name: frontend-test
        display_name: 前端测试
        runner:
          env: pipeline
        condition:
          var: CI_COMMIT_REF_NAME
          operator: eq
          value: main
        steps:
          - name: 检出代码
            run: |
              git clone --branch=$CI_COMMIT_REF_NAME https://gitee.com/$CI_REPO_SLUG.git .
              git log -1

          - name: 前端测试
            run: |
              cd frontend
              npm install
              npm run test
            timeout: 600

  - name: deploy
    display_name: 部署
    jobs:
      - name: backend-deploy
        display_name: 后端部署
        depends_on:
          - backend-test
        if:
          - var: CI_COMMIT_REF_NAME
            operator: eq
            value: main
          - var: CI_EVENT_EVENT
            operator: eq
            value: push
        runner:
          env: pipeline
        steps:
          - name: SSH到服务器构建并部署
            run: |
              # 设置SSH密钥
              mkdir -p ~/.ssh
              echo "$SSH_KEY" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

              # SSH到服务器执行部署
              ssh $SSH_USER@$SSH_HOST "
                cd $PROJECT_PATH

                # 拉取最新代码
                echo '拉取最新代码...'
                git fetch origin
                git checkout $CI_COMMIT_REF_NAME
                git pull origin $CI_COMMIT_REF_NAME

                # 构建后端
                echo '构建后端镜像...'
                cd backend/deploy
                docker build -t alfred-backend:latest .

                # 停止旧容器并启动新容器
                echo '重启后端容器...'
                docker stop alfred-backend 2>/dev/null || true
                docker rm alfred-backend 2>/dev/null || true
                docker-compose up -d

                # 查看容器状态
                sleep 5
                docker ps | grep alfred-backend

                echo '✅ 后端部署完成'
              "
            timeout: 1200

      - name: frontend-deploy
        display_name: 前端部署
        depends_on:
          - frontend-test
        if:
          - var: CI_COMMIT_REF_NAME
            operator: eq
            value: main
          - var: CI_EVENT_EVENT
            operator: eq
            value: push
        runner:
          env: pipeline
        steps:
          - name: SSH到服务器构建并部署
            run: |
              # 设置SSH密钥
              mkdir -p ~/.ssh
              echo "$SSH_KEY" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

              # SSH到服务器执行部署
              ssh $SSH_USER@$SSH_HOST "
                cd $PROJECT_PATH

                # 拉取最新代码
                echo '拉取最新代码...'
                git fetch origin
                git checkout $CI_COMMIT_REF_NAME
                git pull origin $CI_COMMIT_REF_NAME

                # 重新构建前端（如果需要）
                echo '构建前端静态资源...'
                cd frontend
                npm install
                npm run build

                # 复制构建产物
                rm -rf deploy/web/*
                cp -r dist/* deploy/web/

                # 构建前端镜像
                echo '构建前端镜像...'
                cd deploy
                docker build -t alfred-frontend:latest .

                # 重启前端容器
                echo '重启前端容器...'
                docker stop alfred-frontend 2>/dev/null || true
                docker rm alfred-frontend 2>/dev/null || true
                docker-compose up -d

                # 查看容器状态
                sleep 5
                docker ps | grep alfred-frontend

                echo '✅ 前端部署完成'
              "
            timeout: 1200
