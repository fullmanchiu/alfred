# 项目架构文档

## 1. 项目概述

ColaFit 是一个个人健身追踪应用，用于记录体重、分析骑行 FIT 文件并提供 AI 洞察。

### 1.1 核心功能
- 上传和分析 `.fit` 文件
- 查看活动列表和详细信息
- AI 生成的活动报告
- 用户配置文件管理
- 体重记录和健康数据管理
- 活动轨迹地图可视化
- 设置和偏好管理

### 1.2 技术栈
- **后端**: FastAPI (Python)
- **前端**: Flutter
- **数据库**: SQLite
- **AI 服务**: OpenAI API
- **地图服务**: 高德地图 API

## 2. 系统架构

### 2.1 整体架构

ColaFit 采用前后端分离架构，通过 RESTful API 进行通信。

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│                 │       │                 │       │                 │
│   Flutter       │◄────►│   FastAPI       │◄────►│   External      │
│   前端应用       │       │   后端服务       │       │   服务          │
│                 │       │                 │       │                 │
└─────────────────┘       └─────────┬───────┘       └─────────────────┘
                                     │
                                     ▼
                               ┌────────────┐
                               │            │
                               │   SQLite   │
                               │   数据库    │
                               │            │
                               └────────────┘
```

### 2.2 分层架构

#### 2.2.1 后端分层

```
┌─────────────────┐
│   API 路由层     │  # app/api/
└─────────┬───────┘
         │
┌────────▼────────┐
│   业务逻辑层     │  # app/services/
└─────────┬───────┘
         │
┌────────▼────────┐
│   数据访问层     │  # app/models/
└─────────┬───────┘
         │
┌────────▼────────┐
│   数据库         │  # SQLite
└─────────────────┘
```

#### 2.2.2 前端分层

```
┌─────────────────┐
│   屏幕组件        │  # lib/screens/
└─────────┬───────┘
         │
┌────────▼────────┐
│   通用组件        │  # lib/components/
└─────────┬───────┘
         │
┌────────▼────────┐
│   服务层         │  # lib/services/
└─────────┬───────┘
         │
┌────────▼────────┐
│   配置层         │  # lib/config/
└─────────────────┘
```

## 3. 目录结构

### 3.1 项目根目录

```
ColaFit/
├── backend/          # 后端 FastAPI 应用
├── frontend/         # Flutter 应用
├── docs/             # 项目文档
├── LICENSE           # 许可证文件
├── README.md         # 项目说明文档
└── README.en.md      # 英文说明文档
```

### 3.2 后端目录结构

```
backend/
├── app/              # 应用核心代码
│   ├── api/          # API 路由
│   ├── core/         # 核心配置
│   ├── models/       # 数据库模型
│   ├── schemas/      # 数据模式
│   ├── services/     # 业务逻辑服务
│   ├── web/          # Web 路由和模板
│   └── main.py       # 应用入口
├── constraints.txt   # 依赖约束
└── requirements.txt  # Python 依赖配置
```

### 3.3 前端目录结构

```
frontend/
├── lib/              # 应用代码
│   ├── components/   # 通用组件
│   ├── config/       # 配置文件
│   ├── screens/      # 屏幕组件
│   ├── services/     # 服务层
│   ├── app.dart      # 根组件
│   └── main.dart     # 应用入口
├── assets/           # 静态资源
├── android/          # Android 平台代码
├── ios/              # iOS 平台代码
├── linux/            # Linux 平台代码
├── macos/            # macOS 平台代码
├── web/              # Web 平台代码
└── windows/          # Windows 平台代码
```

## 4. 核心功能模块

### 4.1 活动管理模块
- 上传 `.fit` 文件
- 解析和存储活动数据
- 生成活动报告
- 活动列表和详情展示

### 4.2 健康数据模块
- 体重记录
- 身体设置管理
- 健康数据可视化

### 4.3 地图功能模块
- 活动轨迹可视化
- 坐标转换（WGS84 到 GCJ-02）
- 高德地图集成

### 4.4 AI 分析模块
- 调用 OpenAI API 生成活动报告
- 活动数据智能分析

### 4.5 用户管理模块
- 用户注册和登录
- 个人资料管理
- 权限控制

## 5. API 设计

### 5.1 API 版本控制
- 使用 `/api/v1/` 前缀进行版本控制
- 便于未来 API 演进和兼容

### 5.2 主要 API 端点

| 功能          | 端点                          | 方法   |
|-------------|-----------------------------|------|
| 用户注册        | `/api/v1/auth/register`      | POST |
| 用户登录        | `/api/v1/auth/login`         | POST |
| 上传活动文件      | `/api/v1/upload/fit`         | POST |
| 获取活动列表      | `/api/v1/activities`         | GET  |
| 获取活动详情      | `/api/v1/activities/{id}`    | GET  |
| 创建健康记录      | `/api/v1/health/records`     | POST |
| 获取健康记录      | `/api/v1/health/records`     | GET  |
| 更新用户资料      | `/api/v1/user/profile`       | PUT  |
| 获取体重记录      | `/api/v1/health/weight`      | GET  |
| 创建体重记录      | `/api/v1/health/weight`      | POST |

## 6. 数据模型

### 6.1 用户模型
- id: 用户唯一标识
- username: 用户名
- email: 邮箱
- password_hash: 密码哈希
- created_at: 创建时间
- updated_at: 更新时间

### 6.2 活动模型
- id: 活动唯一标识
- user_id: 关联用户
- name: 活动名称
- type: 活动类型（骑行、跑步等）
- start_time: 开始时间
- end_time: 结束时间
- duration: 持续时间
- distance: 距离
- calories: 消耗卡路里
- average_speed: 平均速度
- max_speed: 最大速度
- elevation_gain: 海拔上升
- elevation_loss: 海拔下降
- gps_data: GPS 轨迹数据
- created_at: 创建时间
- updated_at: 更新时间

### 6.3 健康记录模型
- id: 记录唯一标识
- user_id: 关联用户
- record_type: 记录类型（体重、心率等）
- value: 记录值
- unit: 单位
- recorded_at: 记录时间
- created_at: 创建时间
- updated_at: 更新时间

## 7. 部署架构

### 7.1 开发环境
- 后端: `uvicorn app.main:app --reload`
- 前端: `flutter run`
- 数据库: SQLite 文件

### 7.2 生产环境
- 后端: 使用 Gunicorn 或 uvicorn 部署
- 前端: 构建为原生应用或 Web 应用
- 数据库: SQLite 或迁移到 PostgreSQL
- 服务器: Linux 服务器（当前使用 http://110.42.222.64:8000）

## 8. 安全考虑

### 8.1 认证与授权
- 使用 JWT 令牌进行认证
- 密码哈希存储
- 权限控制

### 8.2 API 安全
- CORS 配置
- 请求验证
- 速率限制

### 8.3 数据安全
- 敏感数据加密
- 数据库备份
- 输入验证和过滤

## 9. 性能优化

### 9.1 后端优化
- 数据库索引
- 异步处理
- 缓存机制

### 9.2 前端优化
- 组件懒加载
- 图片优化
- 状态管理优化

## 10. 扩展性设计

### 10.1 功能扩展
- 模块化设计
- 插件式架构
- API 版本控制

### 10.2 技术扩展
- 支持多数据库
- 支持多种 AI 服务
- 支持多种地图服务

## 11. 监控与日志

- API 请求日志
- 错误日志
- 性能监控

## 12. 未来规划

- 添加更多活动类型支持
- 增强 AI 分析功能
- 添加社交分享功能
- 支持更多健康数据类型
- 增强地图功能和可视化效果
- 添加数据分析和报告导出功能
