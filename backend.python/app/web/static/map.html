<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活动轨迹地图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            z-index: 1;
        }
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e74c3c;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }
        #amapContainer {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="mapContainer">
        <div class="loading" id="loadingDiv">
            <div>地图加载中...</div>
        </div>
    </div>

    <!-- 高德地图安全代理配置 -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            serviceHost: window.location.origin + "/_AMapService"
        };
    </script>

    <!-- 高德地图Loader -->
    <script type="text/javascript" src="https://webapi.amap.com/loader.js"></script>

    <script>
        // WGS84转GCJ-02坐标系转换函数
        function wgs84ToGcj02(lng, lat) {
            if (outOfChina(lng, lat)) return { lng, lat };

            const dLat = transformLat(lng - 105.0, lat - 35.0);
            const dLng = transformLng(lng - 105.0, lat - 35.0);
            const radLat = lat / 180.0 * Math.PI;
            const magic = Math.sin(radLat);
            const sqrtMagic = Math.sqrt(1 - 0.006693421622965943 * magic * magic);

            const dLatConv = (dLat * 180.0) / ((6378245.0 / sqrtMagic) * Math.PI);
            const dLngConv = (dLng * 180.0) / ((6378245.0 / sqrtMagic) * Math.cos(radLat) * Math.PI);

            return {
                lng: lng + dLngConv,
                lat: lat + dLatConv
            };
        }

        function transformLat(lng, lat) {
            let ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * Math.PI) + 20.0 * Math.sin(2.0 * lng * Math.PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lat * Math.PI) + 40.0 * Math.sin(lat / 3.0 * Math.PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(lat / 12.0 * Math.PI) + 320 * Math.sin(lat * Math.PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformLng(lng, lat) {
            let ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * Math.PI) + 20.0 * Math.sin(2.0 * lng * Math.PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lng * Math.PI) + 40.0 * Math.sin(lng / 3.0 * Math.PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(lng / 12.0 * Math.PI) + 300.0 * Math.sin(lng / 30.0 * Math.PI)) * 2.0 / 3.0;
            return ret;
        }

        function outOfChina(lng, lat) {
            return lng < 73.66 || lng > 135.05 || lat < 3.86 || lat > 53.55;
        }

        let map = null;
        let currentPoints = [];

        // 初始化地图
        async function initMap(points = null) {
            try {
                const AMap = await AMapLoader.load({
                    key: '480294b8e2302bda9c80df150f6da88b', // 高德地图API key
                    version: '2.0',
                    plugins: ['AMap.Scale', 'AMap.ToolBar', 'AMap.MapType', 'AMap.Polyline', 'AMap.Marker'],
                });

                // 如果提供了GPS点，直接使用
                if (points && points.length > 0) {
                    currentPoints = points;
                    await createMapWithPoints(AMap, points);
                } else {
                    // 否则创建默认地图
                    createDefaultMap(AMap);
                }

                // 隐藏加载提示
                const loading = document.getElementById('loadingDiv');
                if (loading) {
                    loading.style.display = 'none';
                }

            } catch (error) {
                console.error('地图初始化失败:', error);
                showError('地图加载失败');
            }
        }

        // 创建带GPS点的地图
        async function createMapWithPoints(AMap, points) {
            if (!mapContainer) return;

            // 确保容器存在
            let amapContainer = document.getElementById('amapContainer');
            if (!amapContainer) {
                amapContainer = document.createElement('div');
                amapContainer.id = 'amapContainer';
                mapContainer.appendChild(amapContainer);
            }

            // 数据转换
            const validPoints = [];
            let centerLat = 0, centerLng = 0;

            for (const point of points) {
                let lng, lat;

                if (point.longitude !== undefined && point.latitude !== undefined) {
                    lng = point.longitude;
                    lat = point.latitude;
                } else if (point.lng !== undefined && point.lat !== undefined) {
                    lng = point.lng;
                    lat = point.lat;
                } else if (Array.isArray(point) && point.length >= 2) {
                    lng = point[0];
                    lat = point[1];
                } else {
                    continue;
                }

                if (isNaN(lng) || isNaN(lat)) continue;

                // FIT文件坐标转换（semicircles -> degrees）
                if (Math.abs(lng) > 1000 || Math.abs(lat) > 1000) {
                    const fitFactor = 180 / Math.pow(2, 31);
                    lng *= fitFactor;
                    lat *= fitFactor;
                }

                // WGS84 -> GCJ-02
                const gcjResult = wgs84ToGcj02(lng, lat);
                lng = gcjResult.lng;
                lat = gcjResult.lat;

                // 验证坐标范围
                if (lng >= 70 && lng <= 140 && lat >= 15 && lat <= 55) {
                    validPoints.push([lng, lat]);
                    centerLng += lng;
                    centerLat += lat;
                }
            }

            if (validPoints.length === 0) {
                showError('无有效GPS数据');
                return;
            }

            centerLng /= validPoints.length;
            centerLat /= validPoints.length;

            // 创建地图
            map = new AMap.Map(amapContainer, {
                zoom: 13,
                center: [centerLng, centerLat],
                mapStyle: 'amap://styles/normal'
            });

            // 添加控件
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.MapType());

            // 绘制路线
            const polyline = new AMap.Polyline({
                path: validPoints,
                strokeColor: '#4285f4',
                strokeWeight: 4,
                strokeOpacity: 0.8
            });

            map.add(polyline);
            map.setFitView();

            // 添加起点终点标记
            if (validPoints.length > 0) {
                const startMarker = new AMap.Marker({
                    position: validPoints[0],
                    title: '起点',
                    icon: new AMap.Icon({
                        size: new AMap.Size(25, 34),
                        image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png'
                    })
                });

                const endMarker = new AMap.Marker({
                    position: validPoints[validPoints.length - 1],
                    title: '终点',
                    icon: new AMap.Icon({
                        size: new AMap.Size(25, 34),
                        image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png'
                    })
                });

                map.add([startMarker, endMarker]);
            }
        }

        // 创建默认地图
        function createDefaultMap(AMap) {
            let amapContainer = document.getElementById('amapContainer');
            if (!amapContainer) {
                amapContainer = document.createElement('div');
                amapContainer.id = 'amapContainer';
                mapContainer.appendChild(amapContainer);
            }

            map = new AMap.Map(amapContainer, {
                zoom: 13,
                center: [116.397428, 39.90923], // 北京天安门
                viewMode: '2D',
            });

            map.addControl(new AMap.Scale());
            map.addControl(new AMap.ToolBar());
        }

        // 显示错误信息
        function showError(message) {
            const loading = document.getElementById('loadingDiv');
            if (loading) {
                loading.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // 更新路线（用于Flutter调用）
        function updateRoute(points) {
            if (points && points.length > 0) {
                initMap(points);
            }
        }

        // 监听来自Flutter的消息
        window.addEventListener('message', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'updateRoute' && data.points) {
                    updateRoute(data.points);
                }
            } catch (error) {
                console.error('处理消息失败:', error);
            }
        });

        // 页面加载完成后初始化地图
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟初始化，确保所有资源加载完成
            setTimeout(() => {
                initMap();
            }, 100);
        });

    </script>
</body>
</html>