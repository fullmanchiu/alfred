name: Build

on:
  push:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # æˆäºˆå†™å…¥å†…å®¹çš„æƒé™ï¼ˆç”¨äºåˆ›å»º Releaseï¼‰

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ========== åç«¯æ„å»º ==========
      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ç¼“å­˜ Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æˆäºˆæ‰§è¡Œæƒé™
        run: chmod +x backend/gradlew

      - name: æ„å»ºåç«¯
        run: cd backend && ./gradlew bootJar --no-daemon

      # ========== å‰ç«¯æ„å»º ==========
      - name: è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: cd frontend && npm install

      - name: æ„å»ºå‰ç«¯
        run: cd frontend && npm run build:prod

      - name: æ‰“åŒ…å‰ç«¯æ„å»ºäº§ç‰©
        run: |
          cd frontend/dist
          tar czf ../../dist.tar.gz .

      # ========== å‡†å¤‡å‘å¸ƒ ==========
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: echo "VERSION=$(git describe --tags --always)" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/build/libs/app.jar
            dist.tar.gz

      # ========== åˆ›å»º Release ==========
      - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰äº§ç‰©
        if: github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Release v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            backend/build/libs/app.jar
            dist.tar.gz
          body: |
            ## ğŸš€ Alfred v${{ steps.get_version.outputs.VERSION }}

            ### ğŸ“¦ æ„å»ºäº§ç‰©

            - **åç«¯**: app.jar
            - **å‰ç«¯**: dist.tar.gz

            ### ğŸ“ ä½¿ç”¨è¯´æ˜

            \`\`\`bash
            # åç«¯
            java -jar app.jar

            # å‰ç«¯
            tar -xzf dist.tar.gz
            \`\`\`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========== è§¦å‘è‡ªåŠ¨éƒ¨ç½² ==========
      - name: å‘é€ Webhook è§¦å‘éƒ¨ç½²
        if: github.ref == 'refs/heads/master'
        run: |
          VERSION='${{ steps.get_version.outputs.VERSION }}'
          TIMESTAMP=$(date +%s)
          SIGNATURE=$(echo -n "version=${VERSION}&timestamp=${TIMESTAMP}" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" -binary | base64)

          curl -X POST "${{ secrets.WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Signature: ${SIGNATURE}" \
            -H "X-Webhook-Timestamp: ${TIMESTAMP}" \
            -d "{
              \"version\": \"${VERSION}\",
              \"repository\": \"${{ github.repository }}\",
              \"commit\": \"${{ github.sha }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"trigger\": \"${{ github.event_name }}\",
              \"artifacts\": {
                \"backend\": \"https://github.com/${{ github.repository }}/releases/download/v${VERSION}/app.jar\",
                \"frontend\": \"https://github.com/${{ github.repository }}/releases/download/v${VERSION}/dist.tar.gz\"
              }
            }"
